# v0.4.6 - Bug Fixes

**Date:** January 15, 2026  
**Status:** Complete

## Overview

8 bug fixes and improvements addressing error handling, editor synchronization, environment variables, and UX improvements.

## Fixes

### 1. YAML Parse Error Handling

**Problem:** When glance.yml contained invalid YAML, the backend returned 500 errors, causing the frontend to enter a crash loop.

**Solution:**
- `getConfig()` now returns `{ config, parseError }` instead of throwing
- API returns 200 with `parseError` field containing line/column info
- Frontend displays dedicated parse error view with "Open YAML Editor" button
- Users can fix syntax errors directly in the YAML editor

**Implementation:**
- `backend/src/services/configService.js` - Try-catch with error extraction
- `backend/src/routes/config.js` - Returns parseError in response
- `frontend/src/types.ts` - Added `YamlParseError` interface
- `frontend/src/hooks/useConfig.ts` - Added `parseError` state
- `frontend/src/App.tsx` - Parse error view with recovery UI

### 2. Monaco Editor Synchronization

**Problem:** New pages added via the visual editor didn't appear in the Monaco YAML Editor until page refresh.

**Solution:**
- `performSave()` refetches `rawConfig` from server after successful save
- Added Refresh button to CodeEditor component for manual sync

**Implementation:**
- `frontend/src/hooks/useConfig.ts` - Refetch rawConfig after save
- `frontend/src/components/CodeEditor.tsx` - Added `onRefresh` prop and Refresh button

### 3. Automatic Backup on First Run

**Problem:** Users could accidentally corrupt their configuration without any backup to restore from.

**Solution:**
- Creates `glance.initial.backup` on first server startup
- Only creates once (checked by file existence)
- Separate from the rolling `.backup` file created on each save

**Implementation:**
- `backend/src/services/configService.js` - Added `createInitialBackupIfNeeded()` function
- `backend/src/server.js` - Calls backup function on startup

### 4. GLANCE_URL Environment Variable (Runtime)

**Problem:** `GLANCE_URL` only worked at build time, not runtime. Setting it in Docker compose didn't take effect.

**Solution:**
- Added `/api/settings` endpoint returning runtime environment settings
- Frontend fetches `glanceUrl` from API on mount instead of using build-time value

**Implementation:**
- `backend/src/routes/health.js` - Added `/api/settings` endpoint
- `frontend/src/services/api.ts` - Added `getSettings()` method
- `frontend/src/App.tsx` - Fetches `glanceUrl` from API on mount

### 5. Custom API Parameters Display

**Problem:** When custom-api widgets had object values in parameters, they displayed as `[object Object]`.

**Solution:**
- Modified `parseParameters()` to serialize object values to JSON strings for display

**Implementation:**
- `frontend/src/components/CustomApiBuilder.tsx` - JSON.stringify for object parameter values

### 6. Content Editor Popup

**Problem:** Text areas for widget content were too small to comfortably edit longer text.

**Solution:**
- Created `ExpandableTextEditor` component with expand button
- Opens full-screen modal for comfortable editing
- Supports keyboard shortcuts (Escape to close)
- Uses debounced input to prevent lag

**Implementation:**
- `frontend/src/components/inputs/ExpandableTextEditor.tsx` - New component
- `frontend/src/components/WidgetEditor.tsx` - Uses ExpandableTextEditor for 'text' type fields

### 7. Move Widgets Between Pages

**Problem:** No way to copy or move widgets from one page to another without manually editing YAML.

**Solution:**
- Right-click context menu on widgets
- "Copy to page" submenu - duplicates widget to target page
- "Move to page" submenu - moves widget to target page (removes from source)
- Filters out current page from target list

**Implementation:**
- `frontend/src/components/WidgetContextMenu.tsx` - New component with submenus
- `frontend/src/components/LayoutEditor.tsx` - Context menu state and handlers
- `frontend/src/App.tsx` - Copy/move handler functions

### 8. Floating Panel Alignment

**Problem:** Validate button is on the right side of the toolbar, but the panel opened on the left.

**Solution:**
- Added `.floating-panel-right` CSS class with proper positioning
- Applied to theme, code, env-vars, and validation panels

**Implementation:**
- `frontend/src/index.css` - Added `.floating-panel-right` class
- `frontend/src/App.tsx` - Applied class to right-side panels

## API Changes

### New Endpoint: GET /api/settings

Returns runtime settings from environment variables.

**Response:**
```json
{
  "glanceUrl": "http://localhost:8080"
}
```

### Modified Endpoint: GET /api/config

Now returns `parseError` field when YAML is invalid instead of 500 error.

**Response (on parse error):**
```json
{
  "config": null,
  "raw": "invalid: yaml: content",
  "parseError": {
    "message": "Unexpected token",
    "line": 5,
    "column": 10,
    "name": "YAMLParseError"
  }
}
```

## New Components

### ExpandableTextEditor

Textarea with expand button that opens full-screen modal.

**Props:**
- `id?: string` - Optional input ID
- `value: string` - Current text value
- `onChange: (value: string) => void` - Change handler
- `placeholder?: string` - Placeholder text
- `label?: string` - Modal header label
- `rows?: number` - Initial textarea rows (default: 4)

### WidgetContextMenu

Right-click context menu for widgets with copy/move functionality.

**Props:**
- `widget: WidgetConfig` - The widget to operate on
- `columnIndex: number` - Source column index
- `widgetIndex: number` - Source widget index
- `pages: PageConfig[]` - All available pages
- `currentPageIndex: number` - Current page index (excluded from targets)
- `position: { x: number; y: number }` - Menu position
- `onClose: () => void` - Close handler
- `onCopyToPage: (targetPageIndex, widget) => void` - Copy handler
- `onMoveToPage: (targetPageIndex, columnIndex, widgetIndex, widget) => void` - Move handler

## Test Results

All tests passing after updates. New tests added for:
- YAML parse error handling in configService
- `/api/settings` endpoint
- WidgetContextMenu component
- ExpandableTextEditor component
