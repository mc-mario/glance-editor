# v0.5 - Quality of Life

**Date:** January 18, 2026  
**Status:** Complete

## Overview

Undo/redo system, YAML include file management, validation navigation to YAML lines, UI reorganization, and separated Import/Export panels.

## Features

### 1. Undo/Redo System

**Implementation:**
- Created `useHistory` hook maintaining a state stack (max 50 entries)
- Each modification pushes a new state with a description (e.g., "Add widget", "Delete page")
- History truncates when branching (new changes after undo discard the "future")

**UI:**
- Undo/Redo buttons in header with tooltips showing action description
- Keyboard shortcuts: `Ctrl+Z` (undo), `Ctrl+Y` or `Ctrl+Shift+Z` (redo)

See: `frontend/src/hooks/useHistory.ts`, `frontend/src/hooks/useConfig.ts`

### 2. YAML Include File Management

Glance supports splitting configuration across multiple YAML files using `$include:` directives.

**Backend Service:**
- Scans for `$include` directives in main config
- Manages include files with atomic writes
- Security: path normalization, directory traversal prevention, absolute path rejection
- Protection: main config cannot be modified/deleted via include API

**API Endpoints:**
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/includes/files` | List all YAML files in config directory |
| GET | `/api/includes/references` | Get all `$include` directives from main config |
| GET | `/api/includes/file/:path` | Read include file content |
| PUT | `/api/includes/file/:path` | Create or update include file |
| DELETE | `/api/includes/file/:path` | Delete include file |

**Frontend Integration:**
- Files section integrated into CodeEditor panel (not separate floating panel)
- Switch between main config and include files within same editor
- Create, delete, and save include files inline

See: `backend/src/services/includeService.js`, `backend/src/routes/includes.js`, `frontend/src/components/CodeEditor.tsx`

### 3. Validation Navigation

**Problem:** Validation panel showed issues but required manual searching to find the widget in YAML.

**Solution:**
- Created YAML position utilities to locate widgets by page/column/widget indices
- Validation panel items are now clickable
- Clicking opens the YAML editor and scrolls to the exact line

**Implementation:**
- `yamlPosition.ts` parses YAML to find line numbers for specific widgets
- CodeEditor exposes `scrollToLine` method via `forwardRef`/`useImperativeHandle`
- `handleValidationNavigate` in App.tsx coordinates panel opening and scrolling

See: `frontend/src/utils/yamlPosition.ts`, `frontend/src/components/CodeEditor.tsx`, `frontend/src/components/ValidationPanel.tsx`

### 4. UI Reorganization

Major restructuring of header and sidebar layout for cleaner workflow.

#### Header Changes

**Before:**
```
[Logo] [Pages dropdown] [YAML] [Files] [Theme] [Env] [Import/Export] [Validate] [Edit|Preview] [Devices]
```

**After:**
```
[Logo] [Undo] [Redo] [YAML] [Import] [Export] [Validate] [Edit|Preview] [Devices]
```

#### Left Sidebar

```
[Page List]
─────────────
[Theme Button]
```

- Theme button moved from header to bottom of left sidebar
- Opens panel anchored to left side

#### Right Sidebar

```
[Widget Palette / Widget Editor]
─────────────
[▼ Environment]
  [Compact env var list]
  [Copy .env template]
```

- Environment Variables moved from floating panel to collapsible section at bottom
- `compact` prop added to `EnvVarManager` for condensed sidebar display
- Shows env var list with quick export button

See: `frontend/src/App.tsx`, `frontend/src/components/EnvVarManager.tsx`

#### YAML Editor Panel

```
[Header: YAML Editor] [Refresh] [X]
[▼ Files]
  [glance.yml (main)]
  [widgets.yml]
  [+ New file]
─────────────
[Monaco Editor]
```

- Files section integrated directly into panel
- No separate "Files" button in header

### 5. Import/Export Panel Separation

**Problem:** Combined Import/Export panel was cluttered and required scrolling between sections.

**Solution:**
- Split into two dedicated panels: `ExportPanel` and `ImportPanel`
- Two separate header buttons with distinct icons (Upload/Download)
- Export panel: scope selection (widget/page/config), format (YAML/JSON), copy, download
- Import panel: file upload, paste area, target column selection
- Removed redact toggle (export always redacts sensitive data)

See: `frontend/src/components/ExportPanel.tsx`, `frontend/src/components/ImportPanel.tsx`

### 6. Validate Button Simplification

Changed from text button to icon-only button (36x36px):
- Shows error count badge (red) if errors exist
- Shows warning count badge (yellow) if only warnings
- Shows green checkmark if no issues
- Tooltip shows detailed status

See: `frontend/src/App.tsx`

### 7. Context Menu Improvements

Enhanced widget right-click context menu:
- Submenus check available viewport space and flip to left if needed
- Improved hover states and visual feedback

See: `frontend/src/components/WidgetContextMenu.tsx`

### 8. Selection Styling

Improved visual distinction for selected items:
- Widget selection: Added glow shadow effect
- Page selection: Increased opacity and added shadow
- Edit/Preview toggle: Added `shadow-sm` to selected state

See: `frontend/src/components/LayoutEditor.tsx`, `frontend/src/components/PageList.tsx`

## Security Considerations

### Include File API Protection

| Protection | Implementation |
|------------|----------------|
| Path normalization | Prevents `../` directory traversal |
| Absolute path rejection | All paths must be relative |
| Config directory check | All paths verified to be within config dir |
| Main config protection | Cannot modify/delete main config via include API |
| Extension validation | Only `.yml` and `.yaml` allowed |

See: `backend/src/services/includeService.js`

## New Files

| File | Purpose |
|------|---------|
| `frontend/src/hooks/useHistory.ts` | Undo/redo state management |
| `frontend/src/utils/yamlPosition.ts` | YAML widget location utilities |
| `frontend/src/components/ExportPanel.tsx` | Dedicated export functionality |
| `frontend/src/components/ImportPanel.tsx` | Dedicated import functionality |
| `backend/src/services/includeService.js` | Include file operations |
| `backend/src/routes/includes.js` | REST API for include files |

## Deleted Files

| File | Reason |
|------|--------|
| `frontend/src/components/ImportExportPanel.tsx` | Replaced by separate ExportPanel and ImportPanel |

## Next Steps (for v1.0)

1. Add keyboard shortcuts documentation overlay
2. Consider adding "Recent changes" panel showing history entries
3. Add file rename functionality for include files
4. Consider syntax highlighting for `$include` directives in Monaco
